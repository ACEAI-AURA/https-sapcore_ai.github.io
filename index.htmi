import React, { useState, useRef, useEffect } from 'react';
import { 
  Compass, 
  Layers, 
  PlayCircle, 
  BookOpen, 
  UserCircle2, 
  Flame, 
  MessageSquare, 
  Gem, 
  Plus,
  ArrowUpRight,
  TrendingUp,
  Star, 
  Heart,
  X,
  Send,
  Image as ImageIcon,
  Film,
  PenTool,
  LogOut,
  Mail,
  Lock,
  User,
  Camera,
  UserPlus,
  UserCheck,
  Globe,
  Scissors, 
  Users,    
  Search,   
  Bell,
  Edit2, 
  Check, 
  Sparkles,
  Download
} from 'lucide-react';

// --- Firebase Imports ---
import { initializeApp } from 'firebase/app';
import { 
  getFirestore, 
  collection, 
  addDoc, 
  getDocs, 
  query, 
  where 
} from 'firebase/firestore';
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged,
  signInWithCustomToken 
} from 'firebase/auth';

// --- Firebase Configuration & Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

// --- Îã§Íµ≠Ïñ¥ Î≤àÏó≠ Îç∞Ïù¥ÌÑ∞ (SAPCORE) ---
const TRANSLATIONS = {
  ko: {
    login: 'Î°úÍ∑∏Ïù∏',
    signup: 'ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å',
    signupLink: 'ÌöåÏõêÍ∞ÄÏûÖÌïòÍ∏∞',
    loginLink: 'Î°úÍ∑∏Ïù∏ÌïòÍ∏∞',
    noAccount: 'ÏïÑÏßÅ Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî?',
    hasAccount: 'Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî?',
    emailPlace: 'Ïù¥Î©îÏùº (E-mail)',
    pwPlace: 'ÎπÑÎ∞ÄÎ≤àÌò∏ (Password)',
    nickPlace: 'ÎãâÎÑ§ÏûÑ (Nickname)',
    loginFail: 'Î°úÍ∑∏Ïù∏ Ïã§Ìå®: Ïù¥Î©îÏùº ÎòêÎäî ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.',
    emailDup: 'Ïù¥ÎØ∏ Í∞ÄÏûÖÎêú Ïù¥Î©îÏùºÏûÖÎãàÎã§.',
    fillAll: 'Î™®Îì† Ìï≠Î™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.',
    welcome: 'ÌôòÏòÅÌï©ÎãàÎã§',
    explore: 'ÌÉêÏÉâ',
    nodes: 'ÎÖ∏Îìú',
    stories: 'Ïä§ÌÜ†Î¶¨',
    profile: 'ÌîÑÎ°úÌïÑ',
    upload: 'ÏóÖÎ°úÎìú',
    logout: 'Î°úÍ∑∏ÏïÑÏõÉ',
    myUploads: 'ÎÇ¥ ÏûëÌíàÎì§',
    createTitle: 'ÏÉà ÏûëÌíà ÎßåÎì§Í∏∞',
    uploadMoment: 'ÏÇ¨ÏßÑ Ï∂îÍ∞Ä',
    uploadVideo: 'Ïç∏ÎÑ§Ïùº ÏóÖÎ°úÎìú',
    uploadWebtoon: 'ÌëúÏßÄ ÏóÖÎ°úÎìú',
    momentTitle: 'Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
    videoTitle: 'ÏòÅÏÉÅ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
    webtoonTitle: 'ÏõπÌà∞ Ï†úÎ™©ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî',
    webtoonDesc: 'ÏûëÌíàÏùò Ï§ÑÍ±∞Î¶¨ÎÇò ÏÑ§Î™ÖÏùÑ Ï†ÅÏñ¥Ï£ºÏÑ∏Ïöî...',
    commentPlace: 'ÎåìÍ∏Ä Îã¨Í∏∞...',
    follow: 'ÌåîÎ°úÏö∞',
    following: 'ÌåîÎ°úÏûâ',
    loginProcessing: 'Ï≤òÎ¶¨ Ï§ë...',
    errorAuth: 'Ïù∏Ï¶ù Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.',
    noUploads: 'ÏïÑÏßÅ ÏóÖÎ°úÎìúÌïú ÏûëÌíàÏù¥ ÏóÜÏäµÎãàÎã§.',
    chat: 'Ï±ÑÌåÖ',
    groupChat: 'Îã®Ï≤¥ Ï±ÑÌåÖ',
    findGroup: 'Î∞© Ï∞æÍ∏∞',
    createGroup: 'Î∞© ÎßåÎì§Í∏∞',
    newMsg: 'ÏÉà Î©îÏãúÏßÄ',
    editVideo: 'ÎèôÏòÅÏÉÅ Ìé∏Ïßë',
    applyFilter: 'ÌïÑÌÑ∞ Ï†ÅÏö©',
    groupName: 'Î∞© Ïù¥Î¶Ñ ÏûÖÎ†•',
    join: 'Ï∞∏Ïó¨',
    editProfile: 'ÌîÑÎ°úÌïÑ ÏàòÏ†ï',
    save: 'Ï†ÄÏû•',
    cancel: 'Ï∑®ÏÜå',
    recommended: 'ÌöåÏõêÎãòÏùÑ ÏúÑÌïú Ï∂îÏ≤ú',
    interestsUpdated: 'Í¥ÄÏã¨ÏÇ¨Í∞Ä ÏóÖÎç∞Ïù¥Ìä∏ÎêòÏóàÏäµÎãàÎã§!',
    exportData: 'Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ (JSON)'
  },
  en: {
    login: 'Log In',
    signup: 'Sign Up',
    signupLink: 'Sign Up',
    loginLink: 'Log In',
    noAccount: "Don't have an account?",
    hasAccount: 'Already have an account?',
    emailPlace: 'Email',
    pwPlace: 'Password',
    nickPlace: 'Nickname',
    loginFail: 'Login Failed: Please check your email or password.',
    emailDup: 'This email is already registered.',
    fillAll: 'Please fill in all fields.',
    welcome: 'Welcome',
    explore: 'Explore',
    nodes: 'Nodes',
    stories: 'Stories',
    profile: 'Profile',
    upload: 'Upload',
    logout: 'Log Out',
    myUploads: 'My Uploads',
    createTitle: 'Create New',
    uploadMoment: 'Add Photo',
    uploadVideo: 'Upload Thumb',
    uploadWebtoon: 'Upload Cover',
    momentTitle: 'Enter title',
    videoTitle: 'Enter video title',
    webtoonTitle: 'Enter webtoon title',
    webtoonDesc: 'Enter description...',
    commentPlace: 'Add a comment...',
    follow: 'Follow',
    following: 'Following',
    loginProcessing: 'Processing...',
    errorAuth: 'Authentication error. Please try again.',
    noUploads: 'No uploads yet.',
    chat: 'Chat',
    groupChat: 'Group Chat',
    findGroup: 'Find Group',
    createGroup: 'Create Group',
    newMsg: 'New Message',
    editVideo: 'Edit Video',
    applyFilter: 'Apply Filter',
    groupName: 'Enter group name',
    join: 'Join',
    editProfile: 'Edit Profile',
    save: 'Save',
    cancel: 'Cancel',
    recommended: 'Recommended for you',
    interestsUpdated: 'Interests updated!',
    exportData: 'Backup Data (JSON)'
  },
  zh: {
    login: 'ÁôªÂΩï',
    signup: 'Ê≥®ÂÜåÂÆåÊàê',
    signupLink: 'Ê≥®ÂÜå',
    loginLink: 'ÁôªÂΩï',
    noAccount: 'ËøòÊ≤°ÊúâË¥¶Âè∑Ôºü',
    hasAccount: 'Â∑≤ÁªèÊúâË¥¶Âè∑‰∫ÜÔºü',
    emailPlace: 'ÈÇÆÁÆ±',
    pwPlace: 'ÂØÜÁ†Å',
    nickPlace: 'ÊòµÁß∞',
    loginFail: 'ÁôªÂΩïÂ§±Ë¥•ÔºöËØ∑Ê£ÄÊü•ÈÇÆÁÆ±ÊàñÂØÜÁ†Å„ÄÇ',
    emailDup: 'ËØ•ÈÇÆÁÆ±Â∑≤Ë¢´Ê≥®ÂÜå„ÄÇ',
    fillAll: 'ËØ∑Â°´ÂÜôÊâÄÊúâÈ°πÁõÆ„ÄÇ',
    welcome: 'Ê¨¢Ëøé',
    explore: 'Êé¢Á¥¢',
    nodes: 'ËäÇÁÇπ',
    stories: 'ÊïÖ‰∫ã',
    profile: '‰∏™‰∫∫ËµÑÊñô',
    upload: '‰∏ä‰º†',
    logout: 'ÁôªÂá∫',
    myUploads: 'ÊàëÁöÑ‰ΩúÂìÅ',
    createTitle: 'Âàõ‰ΩúÊñ∞‰ΩúÂìÅ',
    uploadMoment: 'Ê∑ªÂä†ÁÖßÁâá',
    uploadVideo: '‰∏ä‰º†Áº©Áï•Âõæ',
    uploadWebtoon: '‰∏ä‰º†Â∞ÅÈù¢',
    momentTitle: 'ËæìÂÖ•Ê†áÈ¢ò',
    videoTitle: 'ËæìÂÖ•ËßÜÈ¢ëÊ†áÈ¢ò',
    webtoonTitle: 'ËæìÂÖ•ÁΩëÊº´Ê†áÈ¢ò',
    webtoonDesc: 'ËØ∑ËæìÂÖ•‰ΩúÂìÅÁÆÄ‰ªã...',
    commentPlace: 'Ê∑ªÂä†ËØÑËÆ∫...',
    follow: 'ÂÖ≥Ê≥®',
    following: 'Â∑≤ÂÖ≥Ê≥®',
    loginProcessing: 'Â§ÑÁêÜ‰∏≠...',
    errorAuth: 'ËÆ§ËØÅÈîôËØØÔºåËØ∑ÈáçËØï„ÄÇ',
    noUploads: 'ÊöÇÊó†‰∏ä‰º†‰ΩúÂìÅ„ÄÇ',
    chat: 'ËÅäÂ§©',
    groupChat: 'Áæ§ËÅä',
    findGroup: 'Êü•ÊâæÁæ§ÁªÑ',
    createGroup: 'ÂàõÂª∫Áæ§ÁªÑ',
    newMsg: 'Êñ∞Ê∂àÊÅØ',
    editVideo: 'ÁºñËæëËßÜÈ¢ë',
    applyFilter: 'Â∫îÁî®Êª§Èïú',
    groupName: 'ËæìÂÖ•Áæ§ÁªÑÂêçÁß∞',
    join: 'Âä†ÂÖ•',
    editProfile: 'ÁºñËæëËµÑÊñô',
    save: '‰øùÂ≠ò',
    cancel: 'ÂèñÊ∂à',
    recommended: '‰∏∫ÊÇ®Êé®Ëçê',
    interestsUpdated: 'ÂÖ¥Ë∂£Â∑≤Êõ¥Êñ∞ÔºÅ',
    exportData: 'Êï∞ÊçÆÂ§á‰ªΩ (JSON)'
  },
  es: {
    login: 'Iniciar Sesi√≥n',
    signup: 'Registrarse',
    signupLink: 'Registrarse',
    loginLink: 'Iniciar Sesi√≥n',
    noAccount: '¬øNo tienes cuenta?',
    hasAccount: '¬øYa tienes cuenta?',
    emailPlace: 'Correo electr√≥nico',
    pwPlace: 'Contrase√±a',
    nickPlace: 'Apodo',
    loginFail: 'Error: Verifica tu correo o contrase√±a.',
    emailDup: 'El correo ya est√° registrado.',
    fillAll: 'Por favor llena todos los campos.',
    welcome: 'Bienvenido',
    explore: 'Explorar',
    nodes: 'Nodos',
    stories: 'Historias',
    profile: 'Perfil',
    upload: 'Subir',
    logout: 'Cerrar sesi√≥n',
    myUploads: 'Mis Subidas',
    createTitle: 'Crear Nuevo',
    uploadMoment: 'A√±adir Foto',
    uploadVideo: 'Subir Miniatura',
    uploadWebtoon: 'Subir Portada',
    momentTitle: 'Introduce el t√≠tulo',
    videoTitle: 'T√≠tulo del video',
    webtoonTitle: 'T√≠tulo del webtoon',
    webtoonDesc: 'Introduce descripci√≥n...',
    commentPlace: 'A√±adir comentario...',
    follow: 'Seguir',
    following: 'Siguiendo',
    loginProcessing: 'Procesando...',
    errorAuth: 'Error de autenticaci√≥n. Int√©ntalo de nuevo.',
    noUploads: 'A√∫n no hay subidas.',
    chat: 'Chat',
    groupChat: 'Chat Grupal',
    findGroup: 'Buscar Grupo',
    createGroup: 'Crear Grupo',
    newMsg: 'Nuevo Mensaje',
    editVideo: 'Editar Video',
    applyFilter: 'Aplicar Filtro',
    groupName: 'Nombre del grupo',
    join: 'Unirse',
    editProfile: 'Editar Perfil',
    save: 'Guardar',
    cancel: 'Cancelar',
    recommended: 'Recomendado para ti',
    interestsUpdated: '¬°Intereses actualizados!',
    exportData: 'Copia de seguridad (JSON)'
  },
  fr: {
    login: 'Connexion',
    signup: "S'inscrire",
    signupLink: "S'inscrire",
    loginLink: 'Connexion',
    noAccount: "Pas de compte ?",
    hasAccount: 'D√©j√† un compte ?',
    emailPlace: 'E-mail',
    pwPlace: 'Mot de passe',
    nickPlace: 'Surnom',
    loginFail: '√âchec : V√©rifiez votre e-mail ou mot de passe.',
    emailDup: 'Cet e-mail est d√©j√† enregistr√©.',
    fillAll: 'Veuillez remplir tous les champs.',
    welcome: 'Bienvenue',
    explore: 'Explorer',
    nodes: 'N≈ìuds',
    stories: 'Histoires',
    profile: 'Profil',
    upload: 'Publier',
    logout: 'D√©connexion',
    myUploads: 'Mes publications',
    createTitle: 'Cr√©er Nouveau',
    uploadMoment: 'Ajouter Photo',
    uploadVideo: 'Miniature',
    uploadWebtoon: 'Couverture',
    momentTitle: 'Entrez le titre',
    videoTitle: 'Titre de la vid√©o',
    webtoonTitle: 'Titre du webtoon',
    webtoonDesc: 'Entrez la description...',
    commentPlace: 'Ajouter un commentaire...',
    follow: 'Suivre',
    following: 'Abonn√©',
    loginProcessing: 'Traitement...',
    errorAuth: 'Erreur d\'authentification. R√©essayez.',
    noUploads: 'Pas encore de publications.',
    chat: 'Discussion',
    groupChat: 'Groupe',
    findGroup: 'Trouver Groupe',
    createGroup: 'Cr√©er Groupe',
    newMsg: 'Nouveau Message',
    editVideo: '√âditer Vid√©o',
    applyFilter: 'Appliquer Filtre',
    groupName: 'Nom du groupe',
    join: 'Rejoindre',
    editProfile: 'Modifier Profil',
    save: 'Sauvegarder',
    cancel: 'Annuler',
    recommended: 'Recommand√© pour vous',
    interestsUpdated: 'Int√©r√™ts mis √† jour !',
    exportData: 'Sauvegarde (JSON)'
  },
  ja: {
    login: '„É≠„Ç∞„Ç§„É≥',
    signup: 'ÁôªÈå≤ÂÆå‰∫Ü',
    signupLink: 'Êñ∞Ë¶èÁôªÈå≤',
    loginLink: '„É≠„Ç∞„Ç§„É≥',
    noAccount: '„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Å™„ÅÑ„Åß„Åô„ÅãÔºü',
    hasAccount: '„Åô„Åß„Å´„Ç¢„Ç´„Ç¶„É≥„Éà„Çí„ÅäÊåÅ„Å°„Åß„Åô„ÅãÔºü',
    emailPlace: '„É°„Éº„É´„Ç¢„Éâ„É¨„Çπ',
    pwPlace: '„Éë„Çπ„ÉØ„Éº„Éâ',
    nickPlace: '„Éã„ÉÉ„ÇØ„Éç„Éº„É†',
    loginFail: '„É≠„Ç∞„Ç§„É≥Â§±ÊïóÔºö„É°„Éº„É´„Åæ„Åü„ÅØ„Éë„Çπ„ÉØ„Éº„Éâ„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    emailDup: '„Åì„ÅÆ„É°„Éº„É´„ÅØÊó¢„Å´ÁôªÈå≤„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ',
    fillAll: '„Åô„Åπ„Å¶„ÅÆÈ†ÖÁõÆ„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    welcome: '„Çà„ÅÜ„Åì„Åù',
    explore: 'Êé¢Á¥¢',
    nodes: '„Éé„Éº„Éâ',
    stories: '„Çπ„Éà„Éº„É™„Éº',
    profile: '„Éó„É≠„Éï„Ç£„Éº„É´',
    upload: '„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ',
    logout: '„É≠„Ç∞„Ç¢„Ç¶„Éà',
    myUploads: 'ÁßÅ„ÅÆ‰ΩúÂìÅ',
    createTitle: 'Êñ∞Ë¶è‰ΩúÊàê',
    uploadMoment: 'ÂÜôÁúüËøΩÂä†',
    uploadVideo: '„Çµ„É†„Éç„Ç§„É´',
    uploadWebtoon: 'Ë°®Á¥ô„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ',
    momentTitle: '„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ',
    videoTitle: 'ÂãïÁîª„Çø„Ç§„Éà„É´',
    webtoonTitle: '„Ç¶„Çß„Éñ„Éà„Ç•„Éº„É≥„ÅÆ„Çø„Ç§„Éà„É´',
    webtoonDesc: 'Ë™¨Êòé„ÇíÂÖ•Âäõ...',
    commentPlace: '„Ç≥„É°„É≥„Éà„ÇíËøΩÂä†...',
    follow: '„Éï„Ç©„É≠„Éº',
    following: '„Éï„Ç©„É≠„Éº‰∏≠',
    loginProcessing: 'Âá¶ÁêÜ‰∏≠...',
    errorAuth: 'Ë™çË®º„Ç®„É©„Éº„ÅåÁô∫Áîü„Åó„Åæ„Åó„Åü„ÄÇÂÜçË©¶Ë°å„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ',
    noUploads: '„Åæ„Å†„Ç¢„ÉÉ„Éó„É≠„Éº„Éâ„Åï„Çå„Åü‰ΩúÂìÅ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ',
    chat: '„ÉÅ„É£„ÉÉ„Éà',
    groupChat: '„Ç∞„É´„Éº„Éó„ÉÅ„É£„ÉÉ„Éà',
    findGroup: '„Ç∞„É´„Éº„Éó„ÇíÊé¢„Åô',
    createGroup: '„Ç∞„É´„Éº„Éó‰ΩúÊàê',
    newMsg: 'Êñ∞„Åó„ÅÑ„É°„ÉÉ„Çª„Éº„Ç∏',
    editVideo: 'ÂãïÁîªÁ∑®ÈõÜ',
    applyFilter: '„Éï„Ç£„É´„Çø„ÉºÈÅ©Áî®',
    groupName: '„Ç∞„É´„Éº„ÉóÂêç„ÇíÂÖ•Âäõ',
    join: 'ÂèÇÂä†',
    editProfile: '„Éó„É≠„Éï„Ç£„Éº„É´Á∑®ÈõÜ',
    save: '‰øùÂ≠ò',
    cancel: '„Ç≠„É£„É≥„Çª„É´',
    recommended: '„ÅÇ„Å™„Åü„Å∏„ÅÆ„Åä„Åô„Åô„ÇÅ',
    interestsUpdated: 'ËààÂë≥„ÅåÊõ¥Êñ∞„Åï„Çå„Åæ„Åó„ÅüÔºÅ',
    exportData: '„Éá„Éº„Çø„Éê„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó (JSON)'
  }
};

// --- Ï¥àÍ∏∞ Îç∞Ïù¥ÌÑ∞ ---
const INITIAL_POSTS = [
  {
    id: 1,
    category: 'Moment',
    author: 'Sapcore_Creator',
    authorAvatar: 'https://i.pravatar.cc/100?u=Sapcore_Creator',
    title: 'ÎØ∏ÎûòÏùò ÏÜåÏÖú ÎØ∏ÎîîÏñ¥Îäî Ïñ¥Îñ§ Î™®ÏäµÏùºÍπåÏöî?',
    preview: 'https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?w=800',
    stats: { engagement: '98%', interactions: '2.4k' },
    tags: ['design', 'future', 'tech']
  },
  {
    id: 2,
    category: 'Concept',
    author: 'Tech_Flow',
    authorAvatar: 'https://i.pravatar.cc/100?u=Tech_Flow',
    title: 'SAPCORE ÎîîÏûêÏù∏ ÏãúÏä§ÌÖú Í∞ÄÏù¥ÎìúÎùºÏù∏',
    preview: 'https://images.unsplash.com/photo-1633356122544-f134324a6cee?w=800',
    stats: { engagement: '85%', interactions: '1.1k' },
    tags: ['ui/ux', 'design', 'system']
  }
];

const INITIAL_COMMENTS = {
  1: [
    { id: 101, user: 'DesignLover', text: 'Ï†ïÎßê Í∏∞ÎåÄÎêòÎäî ÎπÑÏ†ÑÏù¥ÎÑ§Ïöî! üòé', avatar: 'https://i.pravatar.cc/150?u=DesignLover' },
    { id: 102, user: 'Future_Dev', text: 'Îπ®Î¶¨ Ïç®Î≥¥Í≥† Ïã∂ÏäµÎãàÎã§.', avatar: 'https://i.pravatar.cc/150?u=Future_Dev' }
  ]
};

const INITIAL_VIDEOS = [
  { id: 1, title: 'Generative Art Motion', author: 'Visual_X', views: '1.5M', thumb: 'https://images.unsplash.com/photo-1550745165-9bc0b252726f?w=600', tags: ['art', 'motion', 'design'] },
  { id: 2, title: 'Neon Night Cityscape', author: 'CyberRunner', views: '890K', thumb: 'https://images.unsplash.com/photo-1519608487953-e999c86e7455?w=600', tags: ['cyberpunk', 'city', 'future'] }
];

const INITIAL_WEBTOONS = [
  { id: 1, title: 'Ïπ®Î¨µÏùò Í∂§ÎèÑ', desc: 'Ïö∞Ï£ºÎ•º Ïó¨ÌñâÌïòÎäî Í≥†ÎèÖÌïú Ìï≠Ìï¥ÏùºÏßÄ', score: '9.9', author: 'Î£®ÎÇò', img: 'https://images.unsplash.com/photo-1571330735066-03aaa9429d89?w=400', tags: ['space', 'sci-fi'] },
  { id: 2, title: 'ÎÑ§Ïò® Ïã†ÎìúÎ°¨', desc: 'ÏÇ¨Ïù¥Î≤ÑÌéëÌÅ¨ ÎèÑÏãúÏùò ÎØ∏Ïä§ÌÑ∞Î¶¨', score: '9.8', author: 'Ï†úÏù¥', img: 'https://images.unsplash.com/photo-1541562232579-512a21359920?w=400', tags: ['cyberpunk', 'mystery'] }
];

const INITIAL_CHAT_GROUPS = [
  { id: 1, name: 'Webtoon Artists', members: 124, lastMsg: 'ÏÉàÎ°úÏö¥ Ï±ïÌÑ∞ Ïñ∏Ï†ú ÎÇòÏò§ÎÇòÏöî?' },
  { id: 2, name: 'Video Creators', members: 89, lastMsg: 'Ïù¥Î≤à Ìé∏Ïßë Ìö®Í≥º ÎåÄÎ∞ïÏù¥ÎÑ§Ïöî' },
  { id: 3, name: 'Global Friends', members: 350, lastMsg: 'Hello everyone!' }
];

// --- Î©îÏù∏ Ïï± Ïª¥Ìè¨ÎÑåÌä∏ ---
const App = () => {
  const [firebaseUser, setFirebaseUser] = useState(null); 
  const [currentUser, setCurrentUser] = useState(null); 
  const [isLoading, setIsLoading] = useState(false);
  const [loginError, setLoginError] = useState('');
  const [language, setLanguage] = useState('ko'); 
  const t = TRANSLATIONS[language]; 

  const [activeTab, setActiveTab] = useState('explore');
  const [liked, setLiked] = useState({});
  const [posts, setPosts] = useState(INITIAL_POSTS);
  const [videos, setVideos] = useState(INITIAL_VIDEOS);
  const [webtoons, setWebtoons] = useState(INITIAL_WEBTOONS);
  const [followingList, setFollowingList] = useState([]); 
  const [commentsData, setCommentsData] = useState(INITIAL_COMMENTS); 
  const [activePostForComments, setActivePostForComments] = useState(null); 
  const [commentInput, setCommentInput] = useState(''); 

  const [showChatModal, setShowChatModal] = useState(false);
  const [chatGroups, setChatGroups] = useState(INITIAL_CHAT_GROUPS); 
  const [publicGroups, setPublicGroups] = useState([
     { id: 101, name: 'K-Pop Fans', members: 500, desc: 'BTS, Blackpink...' },
     { id: 102, name: 'Coding Study', members: 42, desc: 'React & Firebase' }
  ]); 
  const [activeChatTab, setActiveChatTab] = useState('my'); 
  const [newGroupName, setNewGroupName] = useState('');
  const [notification, setNotification] = useState(null); 

  const [showCompose, setShowCompose] = useState(false);
  const [uploadType, setUploadType] = useState('moment');
  const [inputText, setInputText] = useState('');
  const [inputDesc, setInputDesc] = useState('');
  const [previewUrl, setPreviewUrl] = useState(null);
  const [isEditingVideo, setIsEditingVideo] = useState(false); 
  const [videoFilter, setVideoFilter] = useState(''); 

  const [isEditingProfile, setIsEditingProfile] = useState(false);
  const [editNameInput, setEditNameInput] = useState('');
  const [userInterests, setUserInterests] = useState([]);

  const [authMode, setAuthMode] = useState('login');
  const [authForm, setAuthForm] = useState({ email: '', password: '', nickname: '', avatar: null });

  useEffect(() => {
    if (currentUser) {
      const timer = setTimeout(() => {
        setNotification({
          id: Date.now(),
          title: t.newMsg,
          message: 'Webtoon Artists: ÏïàÎÖïÌïòÏÑ∏Ïöî!',
          icon: MessageSquare
        });
        setTimeout(() => setNotification(null), 3000);
      }, 5000); 
      return () => clearTimeout(timer);
    }
  }, [currentUser, t.newMsg]);

  useEffect(() => {
    const initAuth = async () => {
      if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
        await signInWithCustomToken(auth, __initial_auth_token);
      } else {
        await signInAnonymously(auth);
      }
    };
    initAuth();
    
    const unsubscribe = onAuthStateChanged(auth, (user) => {
      setFirebaseUser(user);
    });
    return () => unsubscribe();
  }, []);

  const handleExportData = () => {
    if (!currentUser) return;

    const exportData = {
      userProfile: currentUser,
      myPosts: posts.filter(p => p.author === currentUser.nickname),
      myVideos: videos.filter(v => v.author === currentUser.nickname),
      myWebtoons: webtoons.filter(w => w.author === currentUser.nickname),
      following: followingList,
      interests: userInterests,
      exportedAt: new Date().toISOString(),
      appVersion: 'Sapcore 1.0'
    };

    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `sapcore_backup_${currentUser.nickname}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const getRecommendationScore = (tags) => {
    if (!tags || tags.length === 0) return 0;
    const matches = tags.filter(tag => userInterests.includes(tag));
    return matches.length;
  };

  const handleImageChange = (e, setUrlFunc) => {
    const file = e.target.files[0];
    if (file) {
      const url = URL.createObjectURL(file);
      setUrlFunc(url);
    }
  };

  const toggleFollow = (authorName) => {
    if (authorName === currentUser.nickname) return; 

    if (followingList.includes(authorName)) {
      setFollowingList(followingList.filter(name => name !== authorName)); 
    } else {
      setFollowingList([...followingList, authorName]); 
    }
  };

  const handleLike = (id, tags) => {
    setLiked(prev => ({...prev, [id]: !prev[id]}));
    
    if (tags && tags.length > 0) {
      const newInterests = [...new Set([...userInterests, ...tags])];
      setUserInterests(newInterests);
    }
  };

  const handleCommentSubmit = () => {
    if (!commentInput.trim() || !activePostForComments) return;

    const newComment = {
      id: Date.now(),
      user: currentUser.nickname,
      avatar: currentUser.avatar,
      text: commentInput
    };

    setCommentsData(prev => ({
      ...prev,
      [activePostForComments]: [...(prev[activePostForComments] || []), newComment]
    }));

    setCommentInput('');
  };

  const handleCreateGroup = () => {
    if (!newGroupName.trim()) return;
    const newGroup = {
      id: Date.now(),
      name: newGroupName,
      members: 1,
      lastMsg: 'ÏÉàÎ°úÏö¥ Ï±ÑÌåÖÎ∞©Ïù¥ ÏÉùÏÑ±ÎêòÏóàÏäµÎãàÎã§.'
    };
    setChatGroups([newGroup, ...chatGroups]);
    setNewGroupName('');
  };

  const handleJoinGroup = (group) => {
    const exists = chatGroups.find(g => g.id === group.id);
    if (!exists) {
      setChatGroups([{ ...group, lastMsg: 'Ï∞∏Ïó¨ÌñàÏäµÎãàÎã§.' }, ...chatGroups]);
      alert(`${group.name} ${t.join} ÏôÑÎ£å!`);
    } else {
      alert('Ïù¥ÎØ∏ Ï∞∏Ïó¨ Ï§ëÏù∏ Î∞©ÏûÖÎãàÎã§.');
    }
  };

  const handleNameUpdate = () => {
    if (editNameInput.trim()) {
      setCurrentUser(prev => ({ ...prev, nickname: editNameInput }));
      setIsEditingProfile(false);
    }
  };

  const handleAuthSubmit = async (e) => {
    e.preventDefault();
    setLoginError(''); 
    if (!firebaseUser) return;

    setIsLoading(true);
    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'aura_users');

    try {
      if (authMode === 'signup') {
        if (!authForm.email || !authForm.password || !authForm.nickname) {
          setLoginError(t.fillAll);
          setIsLoading(false);
          return;
        }

        const q = query(usersRef, where("email", "==", authForm.email));
        const querySnapshot = await getDocs(q);

        if (!querySnapshot.empty) {
          setLoginError(t.emailDup);
          setIsLoading(false);
          return;
        }

        const newUser = {
          email: authForm.email,
          password: authForm.password, 
          nickname: authForm.nickname,
          avatar: authForm.avatar || `https://i.pravatar.cc/150?u=${authForm.email}`,
          stats: { works: 0, level: 1 }
        };

        await addDoc(usersRef, newUser);
        setCurrentUser(newUser);
        setFollowingList([]);

      } else {
        const q = query(usersRef, where("email", "==", authForm.email));
        const querySnapshot = await getDocs(q);

        if (querySnapshot.empty) {
           setLoginError(t.loginFail); 
           setIsLoading(false);
           return;
        }

        let foundUser = null;
        querySnapshot.forEach((doc) => {
           const userData = doc.data();
           if (userData.password === authForm.password) {
             foundUser = userData;
           }
        });

        if (foundUser) {
          setCurrentUser(foundUser);
          setFollowingList([]); 
        } else {
          setLoginError(t.loginFail); 
        }
      }
    } catch (error) {
      console.error("Auth Error:", error);
      setLoginError(t.errorAuth);
    }

    setIsLoading(false);
  };

  const handleLogout = () => {
    setCurrentUser(null);
    setAuthForm({ email: '', password: '', nickname: '', avatar: null });
    setActiveTab('explore');
    setFollowingList([]);
    setLoginError('');
    setUserInterests([]); 
  };

  const handleSubmit = () => {
    if (!inputText.trim()) return;

    const commonData = {
      id: Date.now(),
      author: currentUser.nickname,
      authorAvatar: currentUser.avatar,
      isNew: true,
      tags: ['new', 'user_content'] 
    };

    const imageToUse = previewUrl || `https://picsum.photos/seed/${Date.now()}/800/600`;

    if (uploadType === 'moment') {
      const newPost = {
        ...commonData,
        category: 'My Moment',
        title: inputText,
        preview: imageToUse,
        stats: { engagement: 'New', interactions: '0' },
      };
      setPosts([newPost, ...posts]);
      setActiveTab('explore');
    } else if (uploadType === 'video') {
      const newVideo = {
        ...commonData,
        title: inputText,
        thumb: imageToUse,
        views: '0',
        author: currentUser.nickname,
        filter: videoFilter 
      };
      setVideos([newVideo, ...videos]);
      setActiveTab('nodes');
    } else if (uploadType === 'webtoon') {
      const newWebtoon = {
        ...commonData,
        title: inputText,
        desc: inputDesc || 'ÏûëÌíà ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.',
        img: imageToUse,
        score: '10.0',
        author: currentUser.nickname
      };
      setWebtoons([newWebtoon, ...webtoons]);
      setActiveTab('stories');
    }

    const updatedUser = { ...currentUser, stats: { ...currentUser.stats, works: currentUser.stats.works + 1 } };
    setCurrentUser(updatedUser);
    
    setInputText('');
    setInputDesc('');
    setPreviewUrl(null);
    setShowCompose(false);
    setIsEditingVideo(false);
    setVideoFilter('');
  };

  if (!currentUser) {
    return (
      <div className="max-w-md mx-auto min-h-screen bg-white flex flex-col items-center justify-center p-8 relative overflow-hidden font-sans">
        <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[30%] bg-purple-200 rounded-full blur-[100px] opacity-50"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[30%] bg-blue-200 rounded-full blur-[100px] opacity-50"></div>

        <div className="z-10 w-full relative">
          <div className="flex justify-center gap-3 mb-8">
             {['ko', 'en', 'es', 'fr', 'ja', 'zh'].map(lang => (
               <button 
                 key={lang} 
                 onClick={() => setLanguage(lang)}
                 className={`w-8 h-8 rounded-full border flex items-center justify-center text-[10px] font-bold uppercase transition-all ${language === lang ? 'bg-black text-white border-black scale-110 shadow-md' : 'bg-white text-gray-400 border-gray-200 hover:border-gray-400'}`}
               >
                 {lang}
               </button>
             ))}
          </div>

          <div className="flex flex-col items-center mb-10">
            <div className="w-16 h-16 bg-black rounded-2xl flex items-center justify-center rotate-12 shadow-2xl mb-4">
              <Gem size={32} className="text-white fill-white" />
            </div>
            <h1 className="text-4xl font-black tracking-tighter italic">SAPCORE</h1>
            <p className="text-gray-400 font-medium mt-2">Sapphire AI Core Universe</p>
          </div>

          <form onSubmit={handleAuthSubmit} className="space-y-4">
            {authMode === 'signup' && (
              <div className="animate-in slide-in-from-bottom-5 duration-300 space-y-4">
                 <div className="flex justify-center mb-6">
                    <label className="relative cursor-pointer group">
                       <div className="w-24 h-24 rounded-full bg-gray-100 border-2 border-dashed border-gray-300 flex items-center justify-center overflow-hidden hover:border-black transition-colors">
                          {authForm.avatar ? (
                            <img src={authForm.avatar} alt="profile" className="w-full h-full object-cover" />
                          ) : (
                            <Camera className="text-gray-400" />
                          )}
                       </div>
                       <div className="absolute bottom-0 right-0 bg-black text-white p-1.5 rounded-full shadow-lg">
                         <Plus size={12} />
                       </div>
                       <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageChange(e, (url) => setAuthForm({...authForm, avatar: url}))} />
                    </label>
                 </div>
                 <div className="relative">
                  <User className="absolute left-4 top-3.5 text-gray-400" size={20} />
                  <input 
                    type="text" 
                    placeholder={t.nickPlace}
                    className="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-12 pr-4 outline-none focus:border-black focus:ring-1 focus:ring-black transition-all"
                    value={authForm.nickname}
                    onChange={(e) => setAuthForm({...authForm, nickname: e.target.value})}
                  />
                </div>
              </div>
            )}

            <div className="relative">
              <Mail className="absolute left-4 top-3.5 text-gray-400" size={20} />
              <input 
                type="email" 
                placeholder={t.emailPlace}
                className="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-12 pr-4 outline-none focus:border-black focus:ring-1 focus:ring-black transition-all"
                value={authForm.email}
                onChange={(e) => setAuthForm({...authForm, email: e.target.value})}
              />
            </div>
            <div className="relative">
              <Lock className="absolute left-4 top-3.5 text-gray-400" size={20} />
              <input 
                type="password" 
                placeholder={t.pwPlace}
                className="w-full bg-gray-50 border border-gray-200 rounded-2xl py-3 pl-12 pr-4 outline-none focus:border-black focus:ring-1 focus:ring-black transition-all"
                value={authForm.password}
                onChange={(e) => setAuthForm({...authForm, password: e.target.value})}
              />
            </div>

            <button 
              type="submit" 
              disabled={isLoading}
              className="w-full bg-black text-white py-4 rounded-2xl font-bold text-lg shadow-xl shadow-black/20 hover:scale-[1.02] active:scale-95 transition-all mt-4 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              {isLoading ? t.loginProcessing : (authMode === 'login' ? t.login : t.signup)}
            </button>

            {loginError && (
              <div className="text-center animate-in fade-in duration-300 mt-2">
                 <p className="text-red-500 text-xs font-bold bg-red-50 py-1 px-3 rounded-full inline-block">
                    {loginError}
                 </p>
              </div>
            )}
          </form>

          <div className="mt-6 text-center">
            <p className="text-gray-400 text-sm">
              {authMode === 'login' ? t.noAccount : t.hasAccount}
            </p>
            <button 
              onClick={() => {
                setAuthMode(authMode === 'login' ? 'signup' : 'login');
                setAuthForm({ email: '', password: '', nickname: '', avatar: null });
                setLoginError('');
              }}
              className="text-black font-bold text-sm mt-1 hover:underline"
            >
              {authMode === 'login' ? t.signupLink : t.loginLink}
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-md mx-auto min-h-screen bg-[#F8F9FA] pb-24 font-sans antialiased text-gray-900 relative">
      
      {notification && (
        <div className="fixed top-4 left-4 right-4 z-[70] bg-white border border-gray-100 shadow-xl rounded-2xl p-4 flex items-center gap-3 animate-in slide-in-from-top-4 duration-300">
          <div className="bg-green-100 p-2 rounded-full text-green-600">
            <notification.icon size={20} />
          </div>
          <div>
            <p className="text-xs font-bold text-gray-500">{notification.title}</p>
            <p className="text-sm font-bold">{notification.message}</p>
          </div>
        </div>
      )}

      <div className="sticky top-0 z-40 flex justify-between items-center px-6 py-4 bg-white/70 backdrop-blur-xl">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-black rounded-xl flex items-center justify-center rotate-12 shadow-lg">
            <Gem size={18} className="text-white fill-white" />
          </div>
          <span className="text-xl font-black tracking-tighter italic">SAPCORE</span>
        </div>
        <div className="flex items-center gap-3">
          <button onClick={() => setShowChatModal(true)} className="p-2 bg-white rounded-full shadow-sm hover:bg-gray-50">
            <MessageSquare size={20} className="text-gray-700" />
          </button>
          <div className="bg-white shadow-sm border border-gray-100 rounded-full px-4 py-1.5 flex items-center gap-2">
            <Flame size={14} className="text-orange-500 fill-orange-500" />
            <span className="text-xs font-bold">{1240 + currentUser.stats.works * 50} XP</span>
          </div>
        </div>
      </div>

      <main>
        {activeTab === 'explore' && (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-500">
            <SectionTitle title={t.explore} subtitle={`${t.welcome}, ${currentUser.nickname}!`} />
            <div className="px-6 space-y-6">
              {[...posts]
                .sort((a, b) => getRecommendationScore(b.tags) - getRecommendationScore(a.tags))
                .map(card => {
                const isFollowing = followingList.includes(card.author);
                const isMe = card.author === currentUser.nickname;
                const isRecommended = getRecommendationScore(card.tags) > 0;

                return (
                  <div key={card.id} className="relative group overflow-hidden rounded-[32px] bg-white border border-gray-100 shadow-xl shadow-gray-200/50">
                    <div className="p-5">
                      <div className="flex justify-between items-start mb-4">
                        <div className="flex items-center gap-3">
                          <div className="w-10 h-10 rounded-full bg-gray-200 overflow-hidden border border-gray-100">
                             <img src={card.authorAvatar || `https://i.pravatar.cc/100?u=${card.author}`} alt="avatar" />
                          </div>
                          <div>
                            <span className="text-xs font-bold text-gray-900 block">@{card.author}</span>
                            {!isMe && (
                              <button 
                                onClick={() => toggleFollow(card.author)}
                                className={`text-[10px] font-bold px-2 py-0.5 rounded-full mt-0.5 flex items-center gap-1 transition-all ${
                                  isFollowing 
                                    ? 'bg-gray-100 text-gray-500' 
                                    : 'bg-indigo-50 text-indigo-600 hover:bg-indigo-100'
                                }`}
                              >
                                {isFollowing ? (
                                  <><UserCheck size={10} /> {t.following}</>
                                ) : (
                                  <><UserPlus size={10} /> {t.follow}</>
                                )}
                              </button>
                            )}
                          </div>
                        </div>
                        <div className="flex flex-col items-end gap-1">
                          <div className="px-2 py-1 rounded-lg bg-gray-50 text-[10px] font-black uppercase tracking-widest text-gray-400">
                            {card.category}
                          </div>
                          {isRecommended && (
                             <div className="flex items-center gap-1 text-[10px] font-bold text-indigo-500">
                               <Sparkles size={10} /> {t.recommended}
                             </div>
                          )}
                        </div>
                      </div>
                      <h3 className="text-xl font-bold leading-tight mb-2 group-hover:text-indigo-600 transition-colors break-keep">
                        {card.title}
                      </h3>
                    </div>
                    <div className="relative aspect-[16/10] mx-4 mb-4 rounded-2xl overflow-hidden shadow-inner bg-gray-100">
                      <img src={card.preview} className="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt="content" />
                    </div>
                    <div className="px-5 pb-5 flex justify-between items-center border-t border-gray-50 pt-4">
                       <div className="flex gap-4">
                          <button 
                            onClick={() => handleLike(card.id, card.tags)} 
                            className={`flex items-center gap-1 text-xs font-bold ${liked[card.id] ? 'text-red-500' : 'text-gray-400'}`}
                          >
                            <Heart size={16} className={liked[card.id] ? 'fill-current' : ''} />
                            Like
                          </button>
                          <button 
                            onClick={() => setActivePostForComments(card.id)}
                            className="flex items-center gap-1 text-xs font-bold text-gray-400 hover:text-gray-600"
                          >
                            <MessageSquare size={16} />
                            Comment
                          </button>
                       </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
        )}

        {activeTab === 'nodes' && (
          <div className="animate-in fade-in zoom-in-95 duration-500">
            <SectionTitle title={t.nodes} subtitle="Continuous Visual Experience" />
            <div className="px-6 space-y-8">
              {[...videos]
                .sort((a, b) => getRecommendationScore(b.tags) - getRecommendationScore(a.tags)) 
                .map(node => {
                  const isRecommended = getRecommendationScore(node.tags) > 0;
                  return (
                    <div key={node.id} className="relative">
                      {isRecommended && (
                        <div className="absolute top-2 right-2 z-20 bg-indigo-600 text-white text-[10px] px-2 py-1 rounded-full font-bold flex items-center gap-1 shadow-lg">
                           <Sparkles size={10} /> Pick
                        </div>
                      )}
                      <div className="absolute -left-3 top-0 bottom-0 w-1 bg-gradient-to-b from-black/10 to-transparent rounded-full" />
                      <div className="rounded-[24px] overflow-hidden bg-black group relative shadow-2xl">
                        <img src={node.thumb} className={`w-full aspect-video object-cover opacity-80 group-hover:scale-105 transition-transform duration-1000 ${node.filter || ''}`} alt="v" />
                        <div className="absolute inset-0 flex flex-col justify-between p-6">
                          <div className="flex justify-end">
                            <div className="bg-white/10 backdrop-blur-md px-3 py-1 rounded-full text-[10px] text-white font-bold">
                              {node.views} nodes watching
                            </div>
                          </div>
                          <div className="flex items-end justify-between">
                            <div>
                              <p className="text-white text-lg font-bold leading-tight mb-1">{node.title}</p>
                              <p className="text-white/60 text-xs font-medium">By {node.author}</p>
                            </div>
                            <div className="w-12 h-12 bg-white rounded-2xl flex items-center justify-center shadow-lg transform group-hover:rotate-12 transition-transform">
                              <PlayCircle size={28} className="text-black" />
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  );
              })}
            </div>
          </div>
        )}

        {activeTab === 'stories' && (
           <div className="animate-in slide-in-from-right-10 duration-500">
             <SectionTitle title={t.stories} subtitle="New Dimensions of Story" />
             <div className="px-6 grid grid-cols-1 gap-6">
                {[...webtoons]
                  .sort((a, b) => getRecommendationScore(b.tags) - getRecommendationScore(a.tags))
                  .map(story => {
                    const isRecommended = getRecommendationScore(story.tags) > 0;
                    return (
                      <div key={story.id} className={`flex gap-4 bg-white p-3 rounded-[28px] border hover:shadow-lg transition-all group ${isRecommended ? 'border-indigo-200 shadow-indigo-100' : 'border-gray-100'}`}>
                        <div className="w-24 h-32 rounded-2xl overflow-hidden flex-shrink-0 shadow-md relative">
                          <img src={story.img} className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" alt="s" />
                          {isRecommended && <div className="absolute top-1 left-1 w-2 h-2 bg-indigo-500 rounded-full"></div>}
                        </div>
                        <div className="flex flex-col justify-between py-1 flex-1">
                          <div>
                            <div className="flex items-center gap-1 mb-1">
                              <Star size={12} className="text-yellow-400 fill-yellow-400" />
                              <span className="text-[10px] font-black">{story.score}</span>
                              {story.author === currentUser.nickname && <span className="text-[10px] text-indigo-500 font-bold ml-1">#MY_STORY</span>}
                              {isRecommended && <span className="text-[10px] text-indigo-500 font-bold ml-1 flex items-center"><Sparkles size={8}/> REC</span>}
                            </div>
                            <h4 className="text-lg font-bold tracking-tight mb-1">{story.title}</h4>
                            <p className="text-xs text-gray-500 line-clamp-2 mb-2">{story.desc || 'ÏÑ§Î™ÖÏù¥ ÏóÜÏäµÎãàÎã§.'}</p>
                            <p className="text-[10px] text-gray-400 font-bold">{story.author} ÏûëÍ∞Ä</p>
                          </div>
                          <button className="flex items-center gap-2 text-xs font-black text-black mt-2">
                            ÏßÄÍ∏à Í∞êÏÉÅÌïòÍ∏∞
                            <div className="w-6 h-6 rounded-full bg-black text-white flex items-center justify-center">
                              <Plus size={14} />
                            </div>
                          </button>
                        </div>
                      </div>
                  );
                })}
             </div>
           </div>
        )}

        {activeTab === 'profile' && (
           <div className="animate-in fade-in duration-700">
              <div className="px-6 py-8">
                 <div className="flex flex-col items-center">
                    <div className="relative mb-6">
                      <div className="w-32 h-32 rounded-[48px] bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-1 rotate-6">
                         <img src={currentUser.avatar} className="w-full h-full rounded-[44px] border-4 border-white object-cover -rotate-6" alt="me" />
                      </div>
                    </div>
                    
                    {isEditingProfile ? (
                      <div className="flex items-center gap-2 mb-1">
                        <input 
                          type="text" 
                          value={editNameInput} 
                          onChange={(e) => setEditNameInput(e.target.value)}
                          className="text-2xl font-black italic uppercase text-center bg-gray-100 rounded-lg px-2 py-1 w-48 border-none outline-none"
                          autoFocus
                        />
                        <button onClick={handleNameUpdate} className="p-2 bg-black text-white rounded-full">
                          <Check size={16} />
                        </button>
                        <button onClick={() => setIsEditingProfile(false)} className="p-2 bg-gray-200 text-gray-500 rounded-full">
                          <X size={16} />
                        </button>
                      </div>
                    ) : (
                      <div className="flex items-center gap-2 mb-1">
                        <h2 className="text-2xl font-black italic uppercase">{currentUser.nickname}</h2>
                        <button onClick={() => {
                          setEditNameInput(currentUser.nickname);
                          setIsEditingProfile(true);
                        }} className="p-1.5 bg-gray-50 text-gray-400 rounded-full hover:bg-gray-100 hover:text-black transition-colors">
                          <Edit2 size={14} />
                        </button>
                      </div>
                    )}

                    <p className="text-gray-400 text-sm font-medium mb-6">{currentUser.email}</p>
                    
                    <div className="flex gap-12 mb-8">
                       <div className="text-center">
                         <p className="text-[10px] text-gray-400 font-black uppercase mb-1">Works</p>
                         <p className="text-xl font-black">{currentUser.stats.works}</p>
                       </div>
                       <div className="text-center">
                          <p className="text-[10px] text-gray-400 font-black uppercase mb-1">{t.following}</p>
                          <p className="text-xl font-black text-indigo-600">{followingList.length}</p>
                       </div>
                       <div className="text-center">
                         <p className="text-[10px] text-gray-400 font-black uppercase mb-1">Followers</p>
                         <p className="text-xl font-black">0</p>
                       </div>
                    </div>

                    <div className="flex gap-2 mb-4 w-full">
                      <button 
                        onClick={handleExportData}
                        className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-gray-900 text-white rounded-2xl text-xs font-bold hover:bg-black transition-colors"
                      >
                        <Download size={14} /> {t.exportData}
                      </button>
                      <button 
                        onClick={handleLogout}
                        className="flex-1 flex items-center justify-center gap-2 px-4 py-3 bg-gray-100 text-red-500 rounded-2xl text-xs font-bold hover:bg-gray-200 transition-colors"
                      >
                        <LogOut size={14} /> {t.logout}
                      </button>
                    </div>
                 </div>
              </div>
              
              <div className="px-6">
                 <h3 className="font-bold mb-4 text-sm border-t border-gray-100 pt-6">{t.myUploads}</h3>
                 <div className="grid grid-cols-3 gap-2">
                    {posts.filter(p => p.author === currentUser.nickname).map(p => (
                       <div key={`p-${p.id}`} className="aspect-square bg-gray-100 rounded-xl overflow-hidden"><img src={p.preview} className="w-full h-full object-cover" alt="" /></div>
                    ))}
                    {videos.filter(v => v.author === currentUser.nickname).map(v => (
                       <div key={`v-${v.id}`} className="aspect-square bg-black rounded-xl overflow-hidden relative">
                          <img src={v.thumb} className={`w-full h-full object-cover opacity-80 ${v.filter || ''}`} alt="" />
                          <PlayCircle className="absolute inset-0 m-auto text-white w-6 h-6" />
                       </div>
                    ))}
                    {webtoons.filter(w => w.author === currentUser.nickname).map(w => (
                       <div key={`w-${w.id}`} className="aspect-square bg-gray-100 rounded-xl overflow-hidden relative">
                          <img src={w.img} className="w-full h-full object-cover" alt="" />
                          <span className="absolute bottom-1 right-1 bg-black text-white text-[8px] px-1 rounded">TOON</span>
                       </div>
                    ))}
                    {(posts.filter(p => p.author === currentUser.nickname).length + 
                      videos.filter(v => v.author === currentUser.nickname).length + 
                      webtoons.filter(w => w.author === currentUser.nickname).length) === 0 && (
                        <div className="col-span-3 py-10 text-center text-gray-400 text-xs">
                          {t.noUploads}
                        </div>
                      )}
                 </div>
              </div>
           </div>
        )}
      </main>

      {showChatModal && (
        <div className="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in">
          <div className="bg-white w-full max-w-sm rounded-[32px] h-[70vh] flex flex-col shadow-2xl overflow-hidden">
            <div className="p-4 bg-gray-50 flex justify-between items-center border-b border-gray-100">
               <h3 className="font-black text-lg">{t.chat}</h3>
               <button onClick={() => setShowChatModal(false)} className="p-2 bg-white rounded-full"><X size={18} /></button>
            </div>
            
            <div className="flex p-2 gap-2 bg-gray-50">
               <button onClick={() => setActiveChatTab('my')} className={`flex-1 py-2 text-xs font-bold rounded-xl transition-colors ${activeChatTab === 'my' ? 'bg-black text-white' : 'text-gray-400'}`}>{t.groupChat}</button>
               <button onClick={() => setActiveChatTab('find')} className={`flex-1 py-2 text-xs font-bold rounded-xl transition-colors ${activeChatTab === 'find' ? 'bg-black text-white' : 'text-gray-400'}`}>{t.findGroup}</button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-3">
               {activeChatTab === 'my' ? (
                 <>
                   <div className="flex gap-2 mb-4">
                      <input 
                        type="text" 
                        value={newGroupName} 
                        onChange={e => setNewGroupName(e.target.value)}
                        placeholder={t.groupName}
                        className="flex-1 bg-gray-100 rounded-xl px-3 text-sm border-none"
                      />
                      <button onClick={handleCreateGroup} className="p-2 bg-black text-white rounded-xl"><Plus size={18} /></button>
                   </div>
                   {chatGroups.map(group => (
                     <div key={group.id} className="flex items-center gap-3 p-3 bg-white border border-gray-100 rounded-2xl shadow-sm hover:bg-gray-50 cursor-pointer">
                        <div className="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600">
                           <Users size={20} />
                        </div>
                        <div className="flex-1">
                           <p className="font-bold text-sm">{group.name}</p>
                           <p className="text-xs text-gray-400">{group.lastMsg}</p>
                        </div>
                     </div>
                   ))}
                 </>
               ) : (
                 <>
                   <div className="relative mb-4">
                      <Search className="absolute left-3 top-2.5 text-gray-400" size={16} />
                      <input type="text" placeholder={t.findGroup} className="w-full pl-9 pr-4 py-2 bg-gray-100 rounded-xl text-sm border-none" />
                   </div>
                   {publicGroups.map(group => (
                      <div key={group.id} className="p-4 border border-gray-100 rounded-2xl flex justify-between items-center">
                         <div>
                            <p className="font-bold">{group.name}</p>
                            <p className="text-xs text-gray-400">{group.desc} ‚Ä¢ {group.members}Î™Ö</p>
                         </div>
                         <button 
                           onClick={() => handleJoinGroup(group)}
                           className="px-3 py-1 bg-black text-white text-xs font-bold rounded-lg"
                         >
                           {t.join}
                         </button>
                      </div>
                   ))}
                 </>
               )}
            </div>
          </div>
        </div>
      )}

      {showCompose && (
        <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end sm:items-center justify-center p-4 animate-in fade-in duration-200">
          <div className="bg-white w-full max-w-sm rounded-[32px] p-6 shadow-2xl relative animate-in slide-in-from-bottom-10 duration-300 max-h-[90vh] overflow-y-auto">
            <button 
              onClick={() => {
                setShowCompose(false);
                setPreviewUrl(null);
                setInputText('');
                setInputDesc('');
                setIsEditingVideo(false);
                setVideoFilter('');
              }} 
              className="absolute top-6 right-6 p-2 bg-gray-100 rounded-full hover:bg-gray-200 transition-colors"
            >
              <X size={20} />
            </button>
            
            <h3 className="text-xl font-black mb-4">{t.createTitle}</h3>

            <div className="flex gap-2 mb-6 bg-gray-100 p-1 rounded-2xl">
              {[
                { id: 'moment', icon: Compass, label: 'Moment' },
                { id: 'video', icon: Film, label: 'Video' },
                { id: 'webtoon', icon: PenTool, label: 'Webtoon' }
              ].map(type => (
                <button
                  key={type.id}
                  onClick={() => {
                    setUploadType(type.id);
                    setPreviewUrl(null);
                    setIsEditingVideo(false);
                  }}
                  className={`flex-1 py-3 rounded-xl text-xs font-bold flex items-center justify-center gap-1 transition-all ${
                    uploadType === type.id ? 'bg-white shadow-md text-black' : 'text-gray-400 hover:text-gray-600'
                  }`}
                >
                  <type.icon size={14} />
                  {type.label}
                </button>
              ))}
            </div>

            <div className="space-y-4 mb-6">
               <input
                 type="text"
                 value={inputText}
                 onChange={(e) => setInputText(e.target.value)}
                 placeholder={
                   uploadType === 'moment' ? t.momentTitle :
                   uploadType === 'video' ? t.videoTitle :
                   t.webtoonTitle
                 }
                 className="w-full p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-black/5 placeholder:text-gray-400 text-sm font-bold"
               />

               {uploadType === 'video' && previewUrl && (
                 <div className="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                   <div className="flex justify-between items-center mb-3">
                      <span className="text-xs font-bold flex items-center gap-1"><Scissors size={14} /> {t.editVideo}</span>
                      <button onClick={() => setIsEditingVideo(!isEditingVideo)} className="text-[10px] bg-black text-white px-2 py-1 rounded">
                        {isEditingVideo ? 'Îã´Í∏∞' : 'Ìé∏Ïßë'}
                      </button>
                   </div>
                   {isEditingVideo && (
                     <div className="grid grid-cols-3 gap-2">
                        {['none', 'grayscale(100%)', 'sepia(80%)', 'saturate(200%)', 'hue-rotate(90deg)', 'invert(100%)'].map((filter, i) => (
                           <button 
                             key={i} 
                             onClick={() => setVideoFilter(filter === 'none' ? '' : filter)}
                             className="h-10 rounded bg-gray-200 text-[10px] overflow-hidden relative"
                             style={{ filter: filter }}
                           >
                             Filter {i}
                           </button>
                        ))}
                     </div>
                   )}
                 </div>
               )}

               {uploadType === 'webtoon' ? (
                 <textarea 
                    value={inputDesc}
                    onChange={(e) => setInputDesc(e.target.value)}
                    placeholder={t.webtoonDesc}
                    className="w-full h-24 p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-black/5 resize-none placeholder:text-gray-400 text-sm font-medium"
                 />
               ) : uploadType === 'moment' && (
                 <textarea 
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    placeholder={t.momentTitle}
                    className="w-full h-24 p-4 bg-gray-50 rounded-2xl border-none focus:ring-2 focus:ring-black/5 resize-none placeholder:text-gray-400 text-sm font-medium"
                 />
               )}

               <label className="block w-full h-40 bg-gray-50 rounded-2xl border-2 border-dashed border-gray-200 flex flex-col items-center justify-center cursor-pointer hover:bg-gray-100 hover:border-gray-400 transition-all overflow-hidden relative group">
                  {previewUrl ? (
                    <img src={previewUrl} alt="preview" className="w-full h-full object-cover" style={{ filter: videoFilter }} />
                  ) : (
                     <div className="flex flex-col items-center text-gray-400 group-hover:text-gray-600">
                       <ImageIcon className="w-8 h-8 mb-2" />
                       <span className="text-xs font-bold">
                         {uploadType === 'moment' ? t.uploadMoment : uploadType === 'video' ? t.uploadVideo : t.uploadWebtoon}
                       </span>
                     </div>
                  )}
                  <input type="file" accept="image/*" className="hidden" onChange={(e) => handleImageChange(e, setPreviewUrl)} />
               </label>
            </div>

            <button 
              onClick={handleSubmit}
              className="w-full py-4 bg-black text-white rounded-2xl font-bold flex items-center justify-center gap-2 hover:bg-gray-800 transition-colors active:scale-95"
            >
              <span>{t.upload} ({uploadType.toUpperCase()})</span>
              <Send size={16} />
            </button>
          </div>
        </div>
      )}
      
      {activePostForComments && (
        <div className="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-end sm:items-center justify-center animate-in fade-in duration-200">
          <div className="bg-white w-full max-w-sm rounded-t-[32px] sm:rounded-[32px] h-[80vh] flex flex-col shadow-2xl relative animate-in slide-in-from-bottom-10 duration-300">
            <div className="p-4 border-b border-gray-100 flex justify-between items-center">
              <h3 className="font-bold text-lg ml-2">Comments</h3>
              <button 
                onClick={() => setActivePostForComments(null)}
                className="p-2 bg-gray-100 rounded-full hover:bg-gray-200"
              >
                <X size={18} />
              </button>
            </div>

            <div className="flex-1 overflow-y-auto p-4 space-y-4">
              {(commentsData[activePostForComments] || []).map((comment) => (
                <div key={comment.id} className="flex gap-3">
                   <img src={comment.avatar} className="w-8 h-8 rounded-full object-cover border border-gray-100 flex-shrink-0" alt="avatar" />
                   <div>
                      <p className="text-xs font-bold">{comment.user}</p>
                      <p className="text-sm text-gray-700 bg-gray-50 px-3 py-2 rounded-2xl rounded-tl-none mt-1">{comment.text}</p>
                   </div>
                </div>
              ))}
            </div>

            <div className="p-4 border-t border-gray-100 bg-white rounded-b-[32px]">
               {(followingList.includes(posts.find(p => p.id === activePostForComments)?.author) || 
                 posts.find(p => p.id === activePostForComments)?.author === currentUser.nickname) ? (
                 <div className="flex gap-2">
                   <input 
                     type="text" 
                     value={commentInput}
                     onChange={(e) => setCommentInput(e.target.value)}
                     placeholder={t.commentPlace}
                     className="flex-1 bg-gray-100 border-none rounded-2xl px-4 text-sm focus:ring-2 focus:ring-black/10"
                   />
                   <button 
                     onClick={handleCommentSubmit}
                     className="w-10 h-10 bg-black text-white rounded-full flex items-center justify-center hover:bg-gray-800 disabled:opacity-50"
                     disabled={!commentInput.trim()}
                   >
                     <Send size={16} />
                   </button>
                 </div>
               ) : (
                 <div className="text-center p-3 bg-gray-50 rounded-xl border border-gray-100">
                    <p className="text-xs font-bold text-gray-400 flex items-center justify-center gap-1">
                      <Lock size={12} />
                      {t.follow} to comment
                    </p>
                 </div>
               )}
            </div>
          </div>
        </div>
      )}

      <div className="fixed bottom-6 left-1/2 -translate-x-1/2 w-[90%] max-w-sm z-50">
        <nav className="bg-white/80 backdrop-blur-2xl border border-white/50 shadow-[0_20px_50px_rgba(0,0,0,0.1)] rounded-[32px] px-6 py-4 flex justify-between items-center">
          <NavItem id="explore" icon={Compass} label={t.explore} />
          <NavItem id="nodes" icon={PlayCircle} label={t.nodes} />
          <div className="relative -top-10">
            <button 
              onClick={() => setShowCompose(true)} 
              className="w-14 h-14 bg-black text-white rounded-full flex items-center justify-center shadow-2xl shadow-black/40 hover:rotate-90 transition-transform duration-500"
            >
              <Plus size={32} />
            </button>
          </div>
          <NavItem id="stories" icon={BookOpen} label={t.stories} />
          <NavItem id="profile" icon={UserCircle2} label={t.profile} />
        </nav>
      </div>

    </div>
  );
};

export default App;